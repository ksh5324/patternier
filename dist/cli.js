#!/usr/bin/env node
import b from"path";import X from"fs/promises";import h from"path";import{pathToFileURL as Q}from"url";import L from"fs";var V=/^patternier\..+\.config\.mjs$/;async function D(r){let e=await Y(r);return e?U(e,new Set):{type:"fsd"}}async function Y(r){let e=h.join(r,"patternier.config.mjs");if(L.existsSync(e))return e;let t=(await L.promises.readdir(r)).filter(s=>V.test(s));if(t.length===0)return null;if(t.length===1)return h.join(r,t[0]);let i=t.find(s=>s==="patternier.base.config.mjs");if(i)return h.join(r,i);throw new Error(`Multiple patternier configs found in ${r}: ${t.join(", ")}`)}async function U(r,e){let n=h.resolve(r);if(e.has(n))throw new Error(`Circular config extends detected: ${n}`);e.add(n);let t=await import(Q(n).href),i=t?.config??t?.default??null;if(!i||typeof i!="object")throw new Error(`Invalid config export in ${n}. Export "config" object.`);let s=await Z(i,h.dirname(n),e);return ee(...s,i)}async function Z(r,e,n){let t=r.extends;if(!t)return[];let i=Array.isArray(t)?t:[t],s=[];for(let a of i){let u=h.isAbsolute(a)?a:h.join(e,a);s.push(await U(u,n))}return s}function ee(...r){let e={type:"fsd"};for(let n of r){for(let[t,i]of Object.entries(n))i!==void 0&&(t==="rules"&&typeof i=="object"&&Object.keys(i).length===0||(e[t]=i));n.layers!==void 0&&(e.layers={...e.layers??{},...n.layers??{}}),n.rules!==void 0&&Object.keys(n.rules??{}).length>0&&(e.rules={...e.rules??{},...n.rules??{}})}return e}async function A(r,e,n){return r==="fsd"?(await import("./pattern/fsd.js")).inspectFile(e,n):(await import("./pattern/fsd.js")).inspectFile(e,n)}function M(r,e){let n=e.loc?`${e.loc.line}:${e.loc.col}`:"0:0";return`${r}:${n}  ${e.ruleId}  ${e.message}`}import te from"fs/promises";import ne from"ignore";async function R(r){try{let e=await te.readFile(r,"utf8"),n=ne();return n.add(e),t=>n.ignores(t)}catch(e){if(e?.code==="ENOENT")return()=>!1;throw e}}function _(r){let e=r.slice(2),n,t,i,s,a=!1,u=!1,p=!1,w=!1;for(let c=0;c<e.length;c++){let o=e[c];if(o==="--type"){i=e[c+1],c++;continue}if(o.startsWith("--type=")){i=o.slice(7);continue}if(o==="--format"){s=e[c+1],c++;continue}if(o.startsWith("--format=")){s=o.slice(9);continue}if(o==="--help"||o==="-h"){a=!0;continue}if(o==="--version"||o==="-v"){u=!0;continue}if(o==="--summary"){p=!0;continue}if(o==="--print-config"){w=!0;continue}if(o.startsWith("-"))return{invalid:!0};if(!n){n=o;continue}if(!t){t=o;continue}}return{cmd:n,fileArg:t,cliType:i,format:s,help:a,version:u,summary:p,printConfig:w}}function P(){console.log(`patternier

Usage:
  patternier inspect <file>
  patternier check [file]
  patternier check [file] --type fsd
  patternier check [file] --format json
  patternier check [file] --format sarif
  patternier check [file] --summary
  patternier check [file] --print-config
  patternier --help
  patternier --version

Examples:
  pnpm dev inspect fixtures/features/a/index.ts
  pnpm dev check fixtures/features/a/index.ts
  pnpm dev check
`)}import y from"path";import J from"fs/promises";import re from"picomatch";var W=new Set([".js",".jsx",".ts",".tsx",".mjs",".cjs",".vue"]),z=["**/node_modules/**","**/dist/**","**/.git/**"];function I(r){return r.replaceAll(y.sep,"/")}function G(r,e){let n=re(r);return t=>n(t)||(e?e(t):!1)}async function B(r,e){let n=[];async function t(i){let s=await J.readdir(i,{withFileTypes:!0});for(let a of s){if(a.name==="node_modules"||a.name==="dist"||a.name===".git")continue;let u=y.join(i,a.name);if(a.isDirectory()){let p=I(y.relative(r,u));if(e.isIgnored(p)||e.isIgnored(p+"/**"))continue;await t(u);continue}if(a.isFile()){let p=y.extname(a.name).toLowerCase();if(!W.has(p))continue;let w=I(y.relative(r,u));if(e.isIgnored(w))continue;n.push(u)}}}return await t(r),n}async function E(r,e){let n=y.isAbsolute(e)?e:y.join(r,e),t=y.extname(n).toLowerCase();if(!W.has(t))throw new Error(`Unsupported file extension: ${t}`);if(!(await J.stat(n)).isFile())throw new Error(`Not a file: ${n}`);return n}var ie=process.cwd();async function oe(){let{cmd:r,fileArg:e,cliType:n,format:t,help:i,version:s,summary:a,printConfig:u,invalid:p}=_(process.argv);if(p)return P();if(i)return P();if(s){let g=await X.readFile(new URL("../package.json",import.meta.url),"utf8"),v=JSON.parse(g);console.log(v.version);return}if(!r)return P();if(n&&n!=="fsd"){console.error(`Unknown type: ${n}`),process.exitCode=1;return}let w=n==="fsd"?"fsd":void 0;if(t&&t!=="text"&&t!=="json"&&t!=="sarif"){console.error(`Unknown format: ${t}`),process.exitCode=1;return}let c=ie,o=b.join(c,"patternier.config.mjs"),S=!1;try{await X.stat(o),S=!0}catch{}let x=await D(c),k=S?x.type:w??x.type,C=b.join(c,x.rootDir??".");if(u){process.stdout.write(JSON.stringify({config:x,analysisRoot:C,type:k},null,2)+`
`);return}let q=x.ignores??[],H=await R(b.join(c,".patternierignore")),K=[...z,...q],$=G(K,H),T={repoRoot:c,analysisRoot:C,config:x};if(r==="inspect"){if(!e)return P();try{let g=await E(c,e),v=await A(k,g,T);process.stdout.write(JSON.stringify(v,null,2)+`
`)}catch(g){console.error(g?.message||g),process.exitCode=1}return}if(r==="check"){let g=[],v=[],O=[],j=new Map;if(e){let d;try{d=await E(c,e)}catch(m){console.error(m?.message||m),process.exitCode=1;return}let f=I(b.relative(C,d));if(f.startsWith(".."))g=[d];else if(!$(f))g=[d];else{process.exitCode=0;return}}else g=await B(C,{isIgnored:$});let F=!1;for(let d of g){let f;try{f=await A(k,d,T)}catch(l){F=!0,console.error(l?.message||l);continue}let m=f?.diagnostics??[];if(m.length>0){F=!0;for(let l of m){let N=l.ruleId??"unknown";j.set(N,(j.get(N)??0)+1),t==="json"?v.push({file:f.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error"}):t==="sarif"?O.push({file:f.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error"}):process.stdout.write(M(f.file.relPath,l)+`
`)}}}if(t==="json"?process.stdout.write(JSON.stringify(v,null,2)+`
`):t==="sarif"&&process.stdout.write(JSON.stringify(se(O),null,2)+`
`),a){let d=Array.from(j.values()).reduce((f,m)=>f+m,0);process.stdout.write(`
Summary: ${d} issues
`);for(let[f,m]of j.entries())process.stdout.write(`- ${f}: ${m}
`)}process.exitCode=F?1:0;return}P()}oe().catch(r=>{console.error(r?.stack||r),process.exitCode=1});function se(r){let e=new Map,n=r.map(t=>{e.has(t.ruleId)||e.set(t.ruleId,{id:t.ruleId});let i={physicalLocation:{artifactLocation:{uri:t.file}}};return t.loc&&typeof t.loc.line=="number"&&typeof t.loc.col=="number"&&(i.physicalLocation.region={startLine:t.loc.line,startColumn:t.loc.col}),{ruleId:t.ruleId,level:t.level==="warn"?"warning":"error",message:{text:t.message},locations:[i]}});return{version:"2.1.0",$schema:"https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0.json",runs:[{tool:{driver:{name:"patternier",rules:Array.from(e.values())}},results:n}]}}

#!/usr/bin/env node
import v from"path";import W from"fs/promises";import m from"path";import{pathToFileURL as X}from"url";import $ from"fs";var q=/^patternier\..+\.config\.mjs$/;async function k(n){let e=await H(n);return e?L(e,new Set):{type:"fsd"}}async function H(n){let e=m.join(n,"patternier.config.mjs");if($.existsSync(e))return e;let t=(await $.promises.readdir(n)).filter(a=>q.test(a));if(t.length===0)return null;if(t.length===1)return m.join(n,t[0]);let i=t.find(a=>a==="patternier.base.config.mjs");if(i)return m.join(n,i);throw new Error(`Multiple patternier configs found in ${n}: ${t.join(", ")}`)}async function L(n,e){let r=m.resolve(n);if(e.has(r))throw new Error(`Circular config extends detected: ${r}`);e.add(r);let t=await import(X(r).href),i=t?.config??t?.default??null;if(!i||typeof i!="object")throw new Error(`Invalid config export in ${r}. Export "config" object.`);let a=await K(i,m.dirname(r),e);return Q(a,i)}async function K(n,e,r){let t=n.extends;if(!t)return[];let i=Array.isArray(t)?t:[t],a=[];for(let c of i){let f=m.isAbsolute(c)?c:m.join(e,c);a.push(await L(f,r))}return a}function Q(...n){let e={type:"fsd"};for(let r of n)Object.assign(e,r),r.layers&&(e.layers={...e.layers??{},...r.layers}),r.rules&&(e.rules={...e.rules??{},...r.rules});return e}async function j(n,e,r){return n==="fsd"?(await import("./pattern/fsd.js")).inspectFile(e,r):(await import("./pattern/fsd.js")).inspectFile(e,r)}function N(n,e){let r=e.loc?`${e.loc.line}:${e.loc.col}`:"0:0";return`${n}:${r}  ${e.ruleId}  ${e.message}`}import V from"fs/promises";import Y from"ignore";async function O(n){try{let e=await V.readFile(n,"utf8"),r=Y();return r.add(e),t=>r.ignores(t)}catch(e){if(e?.code==="ENOENT")return()=>!1;throw e}}function D(n){let e=n.slice(2),r,t,i,a,c=!1,f=!1;for(let o=0;o<e.length;o++){let s=e[o];if(s==="--type"){i=e[o+1],o++;continue}if(s.startsWith("--type=")){i=s.slice(7);continue}if(s==="--format"){a=e[o+1],o++;continue}if(s.startsWith("--format=")){a=s.slice(9);continue}if(s==="--help"||s==="-h"){c=!0;continue}if(s==="--version"||s==="-v"){f=!0;continue}if(s.startsWith("-"))return{invalid:!0};if(!r){r=s;continue}if(!t){t=s;continue}}return{cmd:r,fileArg:t,cliType:i,format:a,help:c,version:f}}function y(){console.log(`patternier

Usage:
  patternier inspect <file>
  patternier check [file]
  patternier check [file] --type fsd
  patternier check [file] --format json
  patternier check [file] --format sarif
  patternier --help
  patternier --version

Examples:
  pnpm dev inspect fixtures/features/a/index.ts
  pnpm dev check fixtures/features/a/index.ts
  pnpm dev check
`)}import p from"path";import U from"fs/promises";import Z from"picomatch";var R=new Set([".js",".jsx",".ts",".tsx",".mjs",".cjs",".vue"]),M=["**/node_modules/**","**/dist/**","**/.git/**"];function P(n){return n.replaceAll(p.sep,"/")}function _(n,e){let r=Z(n);return t=>r(t)||(e?e(t):!1)}async function J(n,e){let r=[];async function t(i){let a=await U.readdir(i,{withFileTypes:!0});for(let c of a){if(c.name==="node_modules"||c.name==="dist"||c.name===".git")continue;let f=p.join(i,c.name);if(c.isDirectory()){let o=P(p.relative(n,f));if(e.isIgnored(o)||e.isIgnored(o+"/**"))continue;await t(f);continue}if(c.isFile()){let o=p.extname(c.name).toLowerCase();if(!R.has(o))continue;let s=P(p.relative(n,f));if(e.isIgnored(s))continue;r.push(f)}}}return await t(n),r}async function b(n,e){let r=p.isAbsolute(e)?e:p.join(n,e),t=p.extname(r).toLowerCase();if(!R.has(t))throw new Error(`Unsupported file extension: ${t}`);if(!(await U.stat(r)).isFile())throw new Error(`Not a file: ${r}`);return r}var ee=process.cwd();async function te(){let{cmd:n,fileArg:e,cliType:r,format:t,help:i,version:a,invalid:c}=D(process.argv);if(c)return y();if(i)return y();if(a){let u=await W.readFile(new URL("../package.json",import.meta.url),"utf8"),d=JSON.parse(u);console.log(d.version);return}if(!n)return y();if(r&&r!=="fsd"){console.error(`Unknown type: ${r}`),process.exitCode=1;return}let f=r==="fsd"?"fsd":void 0;if(t&&t!=="text"&&t!=="json"&&t!=="sarif"){console.error(`Unknown format: ${t}`),process.exitCode=1;return}let o=ee,s=v.join(o,"patternier.config.mjs"),F=!1;try{await W.stat(s),F=!0}catch{}let w=await k(o),E=F?w.type:f??w.type,C=v.join(o,w.rootDir??"."),z=w.ignores??[],G=await O(v.join(o,".patternierignore")),B=[...M,...z],A=_(B,G),T={repoRoot:o,analysisRoot:C,config:w};if(n==="inspect"){if(!e)return y();try{let u=await b(o,e),d=await j(E,u,T);process.stdout.write(JSON.stringify(d,null,2)+`
`)}catch(u){console.error(u?.message||u),process.exitCode=1}return}if(n==="check"){let u=[],d=[],S=[];if(e){let h;try{h=await b(o,e)}catch(x){console.error(x?.message||x),process.exitCode=1;return}let g=P(v.relative(C,h));if(g.startsWith(".."))u=[h];else if(!A(g))u=[h];else{process.exitCode=0;return}}else u=await J(C,{isIgnored:A});let I=!1;for(let h of u){let g;try{g=await j(E,h,T)}catch(l){I=!0,console.error(l?.message||l);continue}let x=g?.diagnostics??[];if(x.length>0){I=!0;for(let l of x)t==="json"?d.push({file:g.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error"}):t==="sarif"?S.push({file:g.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error"}):process.stdout.write(N(g.file.relPath,l)+`
`)}}t==="json"?process.stdout.write(JSON.stringify(d,null,2)+`
`):t==="sarif"&&process.stdout.write(JSON.stringify(re(S),null,2)+`
`),process.exitCode=I?1:0;return}y()}te().catch(n=>{console.error(n?.stack||n),process.exitCode=1});function re(n){let e=new Map,r=n.map(t=>{e.has(t.ruleId)||e.set(t.ruleId,{id:t.ruleId});let i={physicalLocation:{artifactLocation:{uri:t.file}}};return t.loc&&typeof t.loc.line=="number"&&typeof t.loc.col=="number"&&(i.physicalLocation.region={startLine:t.loc.line,startColumn:t.loc.col}),{ruleId:t.ruleId,level:t.level==="warn"?"warning":"error",message:{text:t.message},locations:[i]}});return{version:"2.1.0",$schema:"https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0.json",runs:[{tool:{driver:{name:"patternier",rules:Array.from(e.values())}},results:r}]}}

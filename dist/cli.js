#!/usr/bin/env node
import v from"path";import O from"fs/promises";import W from"path";import{pathToFileURL as z}from"url";import B from"fs";async function T(n){let t=W.join(n,"patternier.config.mjs");if(!B.existsSync(t))return{type:"fsd"};let r=await import(z(t).href),e=r?.config??r?.default??null;if(!e||typeof e!="object")throw new Error(`Invalid config export in ${t}. Export "config" object.`);return e}async function b(n,t,r){return n==="fsd"?(await import("./pattern/fsd.js")).inspectFile(t,r):(await import("./pattern/fsd.js")).inspectFile(t,r)}function C(n,t){let r=t.loc?`${t.loc.line}:${t.loc.col}`:"0:0";return`${n}:${r}  ${t.ruleId}  ${t.message}`}import G from"fs/promises";import X from"ignore";async function S(n){try{let t=await G.readFile(n,"utf8"),r=X();return r.add(t),e=>r.ignores(e)}catch(t){if(t?.code==="ENOENT")return()=>!1;throw t}}function $(n){let t=n.slice(2),r,e,a,g,c=!1,i=!1;for(let s=0;s<t.length;s++){let o=t[s];if(o==="--type"){a=t[s+1],s++;continue}if(o.startsWith("--type=")){a=o.slice(7);continue}if(o==="--format"){g=t[s+1],s++;continue}if(o.startsWith("--format=")){g=o.slice(9);continue}if(o==="--help"||o==="-h"){c=!0;continue}if(o==="--version"||o==="-v"){i=!0;continue}if(o.startsWith("-"))return{invalid:!0};if(!r){r=o;continue}if(!e){e=o;continue}}return{cmd:r,fileArg:e,cliType:a,format:g,help:c,version:i}}function h(){console.log(`patternier

Usage:
  patternier inspect <file>
  patternier check [file]
  patternier check [file] --type fsd
  patternier check [file] --format json
  patternier check [file] --format sarif
  patternier --help
  patternier --version

Examples:
  pnpm dev inspect fixtures/features/a/index.ts
  pnpm dev check fixtures/features/a/index.ts
  pnpm dev check
`)}import u from"path";import R from"fs/promises";import q from"picomatch";var L=new Set([".js",".jsx",".ts",".tsx",".mjs",".cjs"]),D=["**/node_modules/**","**/dist/**","**/.git/**"];function x(n){return n.replaceAll(u.sep,"/")}function N(n,t){let r=q(n);return e=>r(e)||(t?t(e):!1)}async function U(n,t){let r=[];async function e(a){let g=await R.readdir(a,{withFileTypes:!0});for(let c of g){if(c.name==="node_modules"||c.name==="dist"||c.name===".git")continue;let i=u.join(a,c.name);if(c.isDirectory()){let s=x(u.relative(n,i));if(t.isIgnored(s)||t.isIgnored(s+"/**"))continue;await e(i);continue}if(c.isFile()){let s=u.extname(c.name).toLowerCase();if(!L.has(s))continue;let o=x(u.relative(n,i));if(t.isIgnored(o))continue;r.push(i)}}}return await e(n),r}async function F(n,t){let r=u.isAbsolute(t)?t:u.join(n,t),e=u.extname(r).toLowerCase();if(!L.has(e))throw new Error(`Unsupported file extension: ${e}`);if(!(await R.stat(r)).isFile())throw new Error(`Not a file: ${r}`);return r}var H=process.cwd();async function K(){let{cmd:n,fileArg:t,cliType:r,format:e,help:a,version:g,invalid:c}=$(process.argv);if(c)return h();if(a)return h();if(g){let f=await O.readFile(new URL("../package.json",import.meta.url),"utf8"),m=JSON.parse(f);console.log(m.version);return}if(!n)return h();if(r&&r!=="fsd"){console.error(`Unknown type: ${r}`),process.exitCode=1;return}if(e&&e!=="text"&&e!=="json"&&e!=="sarif"){console.error(`Unknown format: ${e}`),process.exitCode=1;return}let i=H,s=v.join(i,"patternier.config.mjs"),o=!1;try{await O.stat(s),o=!0}catch{}let y=await T(i),P=o?y.type:r??y.type,I=v.join(i,y.rootDir??"."),M=y.ignores??[],_=await S(v.join(i,".patternierignore")),J=[...D,...M],k=N(J,_),A={repoRoot:i,analysisRoot:I,config:y};if(n==="inspect"){if(!t)return h();try{let f=await F(i,t),m=await b(P,f,A);process.stdout.write(JSON.stringify(m,null,2)+`
`)}catch(f){console.error(f?.message||f),process.exitCode=1}return}if(n==="check"){let f=[],m=[],E=[];if(t){let d;try{d=await F(i,t)}catch(w){console.error(w?.message||w),process.exitCode=1;return}let p=x(v.relative(I,d));if(p.startsWith(".."))f=[d];else if(!k(p))f=[d];else{process.exitCode=0;return}}else f=await U(I,{isIgnored:k});let j=!1;for(let d of f){let p;try{p=await b(P,d,A)}catch(l){j=!0,console.error(l?.message||l);continue}let w=p?.diagnostics??[];if(w.length>0){j=!0;for(let l of w)e==="json"?m.push({file:p.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error"}):e==="sarif"?E.push({file:p.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error"}):process.stdout.write(C(p.file.relPath,l)+`
`)}}e==="json"?process.stdout.write(JSON.stringify(m,null,2)+`
`):e==="sarif"&&process.stdout.write(JSON.stringify(Q(E),null,2)+`
`),process.exitCode=j?1:0;return}h()}K().catch(n=>{console.error(n?.stack||n),process.exitCode=1});function Q(n){let t=new Map,r=n.map(e=>{t.has(e.ruleId)||t.set(e.ruleId,{id:e.ruleId});let a={physicalLocation:{artifactLocation:{uri:e.file}}};return e.loc&&typeof e.loc.line=="number"&&typeof e.loc.col=="number"&&(a.physicalLocation.region={startLine:e.loc.line,startColumn:e.loc.col}),{ruleId:e.ruleId,level:e.level==="warn"?"warning":"error",message:{text:e.message},locations:[a]}});return{version:"2.1.0",$schema:"https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0.json",runs:[{tool:{driver:{name:"patternier",rules:Array.from(t.values())}},results:r}]}}

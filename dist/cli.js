#!/usr/bin/env node
import C from"path";import B from"fs/promises";import h from"path";import{pathToFileURL as K}from"url";import N from"fs";var Q=/^patternier\..+\.config\.mjs$/;async function O(n){let e=await V(n);return e?D(e,new Set):{type:"fsd"}}async function V(n){let e=h.join(n,"patternier.config.mjs");if(N.existsSync(e))return e;let t=(await N.promises.readdir(n)).filter(i=>Q.test(i));if(t.length===0)return null;if(t.length===1)return h.join(n,t[0]);let o=t.find(i=>i==="patternier.base.config.mjs");if(o)return h.join(n,o);throw new Error(`Multiple patternier configs found in ${n}: ${t.join(", ")}`)}async function D(n,e){let r=h.resolve(n);if(e.has(r))throw new Error(`Circular config extends detected: ${r}`);e.add(r);let t=await import(K(r).href),o=t?.config??t?.default??null;if(!o||typeof o!="object")throw new Error(`Invalid config export in ${r}. Export "config" object.`);let i=await Y(o,h.dirname(r),e);return Z(i,o)}async function Y(n,e,r){let t=n.extends;if(!t)return[];let o=Array.isArray(t)?t:[t],i=[];for(let a of o){let u=h.isAbsolute(a)?a:h.join(e,a);i.push(await D(u,r))}return i}function Z(...n){let e={type:"fsd"};for(let r of n)Object.assign(e,r),r.layers&&(e.layers={...e.layers??{},...r.layers}),r.rules&&(e.rules={...e.rules??{},...r.rules});return e}async function F(n,e,r){return n==="fsd"?(await import("./pattern/fsd.js")).inspectFile(e,r):(await import("./pattern/fsd.js")).inspectFile(e,r)}function U(n,e){let r=e.loc?`${e.loc.line}:${e.loc.col}`:"0:0";return`${n}:${r}  ${e.ruleId}  ${e.message}`}import ee from"fs/promises";import te from"ignore";async function M(n){try{let e=await ee.readFile(n,"utf8"),r=te();return r.add(e),t=>r.ignores(t)}catch(e){if(e?.code==="ENOENT")return()=>!1;throw e}}function R(n){let e=n.slice(2),r,t,o,i,a=!1,u=!1,p=!1;for(let s=0;s<e.length;s++){let c=e[s];if(c==="--type"){o=e[s+1],s++;continue}if(c.startsWith("--type=")){o=c.slice(7);continue}if(c==="--format"){i=e[s+1],s++;continue}if(c.startsWith("--format=")){i=c.slice(9);continue}if(c==="--help"||c==="-h"){a=!0;continue}if(c==="--version"||c==="-v"){u=!0;continue}if(c==="--summary"){p=!0;continue}if(c.startsWith("-"))return{invalid:!0};if(!r){r=c;continue}if(!t){t=c;continue}}return{cmd:r,fileArg:t,cliType:o,format:i,help:a,version:u,summary:p}}function x(){console.log(`patternier

Usage:
  patternier inspect <file>
  patternier check [file]
  patternier check [file] --type fsd
  patternier check [file] --format json
  patternier check [file] --format sarif
  patternier check [file] --summary
  patternier --help
  patternier --version

Examples:
  pnpm dev inspect fixtures/features/a/index.ts
  pnpm dev check fixtures/features/a/index.ts
  pnpm dev check
`)}import y from"path";import _ from"fs/promises";import re from"picomatch";var J=new Set([".js",".jsx",".ts",".tsx",".mjs",".cjs",".vue"]),W=["**/node_modules/**","**/dist/**","**/.git/**"];function I(n){return n.replaceAll(y.sep,"/")}function z(n,e){let r=re(n);return t=>r(t)||(e?e(t):!1)}async function G(n,e){let r=[];async function t(o){let i=await _.readdir(o,{withFileTypes:!0});for(let a of i){if(a.name==="node_modules"||a.name==="dist"||a.name===".git")continue;let u=y.join(o,a.name);if(a.isDirectory()){let p=I(y.relative(n,u));if(e.isIgnored(p)||e.isIgnored(p+"/**"))continue;await t(u);continue}if(a.isFile()){let p=y.extname(a.name).toLowerCase();if(!J.has(p))continue;let s=I(y.relative(n,u));if(e.isIgnored(s))continue;r.push(u)}}}return await t(n),r}async function A(n,e){let r=y.isAbsolute(e)?e:y.join(n,e),t=y.extname(r).toLowerCase();if(!J.has(t))throw new Error(`Unsupported file extension: ${t}`);if(!(await _.stat(r)).isFile())throw new Error(`Not a file: ${r}`);return r}var ne=process.cwd();async function oe(){let{cmd:n,fileArg:e,cliType:r,format:t,help:o,version:i,summary:a,invalid:u}=R(process.argv);if(u)return x();if(o)return x();if(i){let g=await B.readFile(new URL("../package.json",import.meta.url),"utf8"),w=JSON.parse(g);console.log(w.version);return}if(!n)return x();if(r&&r!=="fsd"){console.error(`Unknown type: ${r}`),process.exitCode=1;return}let p=r==="fsd"?"fsd":void 0;if(t&&t!=="text"&&t!=="json"&&t!=="sarif"){console.error(`Unknown format: ${t}`),process.exitCode=1;return}let s=ne,c=C.join(s,"patternier.config.mjs"),E=!1;try{await B.stat(c),E=!0}catch{}let P=await O(s),$=E?P.type:p??P.type,j=C.join(s,P.rootDir??"."),X=P.ignores??[],q=await M(C.join(s,".patternierignore")),H=[...W,...X],k=z(H,q),S={repoRoot:s,analysisRoot:j,config:P};if(n==="inspect"){if(!e)return x();try{let g=await A(s,e),w=await F($,g,S);process.stdout.write(JSON.stringify(w,null,2)+`
`)}catch(g){console.error(g?.message||g),process.exitCode=1}return}if(n==="check"){let g=[],w=[],T=[],v=new Map;if(e){let d;try{d=await A(s,e)}catch(m){console.error(m?.message||m),process.exitCode=1;return}let f=I(C.relative(j,d));if(f.startsWith(".."))g=[d];else if(!k(f))g=[d];else{process.exitCode=0;return}}else g=await G(j,{isIgnored:k});let b=!1;for(let d of g){let f;try{f=await F($,d,S)}catch(l){b=!0,console.error(l?.message||l);continue}let m=f?.diagnostics??[];if(m.length>0){b=!0;for(let l of m){let L=l.ruleId??"unknown";v.set(L,(v.get(L)??0)+1),t==="json"?w.push({file:f.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error"}):t==="sarif"?T.push({file:f.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error"}):process.stdout.write(U(f.file.relPath,l)+`
`)}}}if(t==="json"?process.stdout.write(JSON.stringify(w,null,2)+`
`):t==="sarif"&&process.stdout.write(JSON.stringify(se(T),null,2)+`
`),a){let d=Array.from(v.values()).reduce((f,m)=>f+m,0);process.stdout.write(`
Summary: ${d} issues
`);for(let[f,m]of v.entries())process.stdout.write(`- ${f}: ${m}
`)}process.exitCode=b?1:0;return}x()}oe().catch(n=>{console.error(n?.stack||n),process.exitCode=1});function se(n){let e=new Map,r=n.map(t=>{e.has(t.ruleId)||e.set(t.ruleId,{id:t.ruleId});let o={physicalLocation:{artifactLocation:{uri:t.file}}};return t.loc&&typeof t.loc.line=="number"&&typeof t.loc.col=="number"&&(o.physicalLocation.region={startLine:t.loc.line,startColumn:t.loc.col}),{ruleId:t.ruleId,level:t.level==="warn"?"warning":"error",message:{text:t.message},locations:[o]}});return{version:"2.1.0",$schema:"https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0.json",runs:[{tool:{driver:{name:"patternier",rules:Array.from(e.values())}},results:r}]}}

#!/usr/bin/env node
import E from"path";import H from"fs/promises";import h from"path";import{pathToFileURL as Y}from"url";import R from"fs";var Z=/^patternier\..+\.config\.mjs$/;async function D(r){let e=await ee(r);return e?U(e,new Set):{type:"fsd"}}async function ee(r){let e=h.join(r,"patternier.config.mjs");if(R.existsSync(e))return e;let t=(await R.promises.readdir(r)).filter(s=>Z.test(s));if(t.length===0)return null;if(t.length===1)return h.join(r,t[0]);let i=t.find(s=>s==="patternier.base.config.mjs");if(i)return h.join(r,i);throw new Error(`Multiple patternier configs found in ${r}: ${t.join(", ")}`)}async function U(r,e){let n=h.resolve(r);if(e.has(n))throw new Error(`Circular config extends detected: ${n}`);e.add(n);let t=await import(Y(n).href),i=t?.config??t?.default??null;if(!i||typeof i!="object")throw new Error(`Invalid config export in ${n}. Export "config" object.`);let s=await te(i,h.dirname(n),e);return ne(...s,i)}async function te(r,e,n){let t=r.extends;if(!t)return[];let i=Array.isArray(t)?t:[t],s=[];for(let a of i){let u=h.isAbsolute(a)?a:h.join(e,a);s.push(await U(u,n))}return s}function ne(...r){let e={type:"fsd"};for(let n of r){for(let[t,i]of Object.entries(n))i!==void 0&&(t==="rules"&&typeof i=="object"&&Object.keys(i).length===0||(e[t]=i));n.layers!==void 0&&(e.layers={...e.layers??{},...n.layers??{}}),n.rules!==void 0&&Object.keys(n.rules??{}).length>0&&(e.rules={...e.rules??{},...n.rules??{}})}return e}async function A(r,e,n){return r==="fsd"?(await import("./pattern/fsd.js")).inspectFile(e,n):(await import("./pattern/fsd.js")).inspectFile(e,n)}function _(r,e){let n=e.loc?`${e.loc.line}:${e.loc.col}`:"0:0";return`${r}:${n}  ${e.ruleId}  ${e.message}`}import re from"fs/promises";import ie from"ignore";async function J(r){try{let e=await re.readFile(r,"utf8"),n=ie();return n.add(e),t=>n.ignores(t)}catch(e){if(e?.code==="ENOENT")return()=>!1;throw e}}function W(r){let e=r.slice(2),n,t,i,s,a=!1,u=!1,g=!1,w=!1,C=!1;for(let c=0;c<e.length;c++){let o=e[c];if(o==="--type"){i=e[c+1],c++;continue}if(o.startsWith("--type=")){i=o.slice(7);continue}if(o==="--format"){s=e[c+1],c++;continue}if(o.startsWith("--format=")){s=o.slice(9);continue}if(o==="--help"||o==="-h"){a=!0;continue}if(o==="--version"||o==="-v"){u=!0;continue}if(o==="--summary"){g=!0;continue}if(o==="--print-config"){w=!0;continue}if(o==="--explain"||o==="--why"){C=!0;continue}if(o.startsWith("-"))return{invalid:!0};if(!n){n=o;continue}if(!t){t=o;continue}}return{cmd:n,fileArg:t,cliType:i,format:s,help:a,version:u,summary:g,printConfig:w,explain:C}}function v(){console.log(`patternier

Usage:
  patternier inspect <file>
  patternier check [file]
  patternier check [file] --type fsd
  patternier check [file] --format json
  patternier check [file] --format sarif
  patternier check [file] --summary
  patternier check [file] --print-config
  patternier check [file] --explain
  patternier check [file] --why
  patternier --help
  patternier --version

Examples:
  pnpm dev inspect fixtures/features/a/index.ts
  pnpm dev check fixtures/features/a/index.ts
  pnpm dev check
`)}import y from"path";import z from"fs/promises";import oe from"picomatch";var G=new Set([".js",".jsx",".ts",".tsx",".mjs",".cjs",".vue"]),B=["**/node_modules/**","**/dist/**","**/.git/**"];function k(r){return r.replaceAll(y.sep,"/")}function X(r,e){let n=oe(r);return t=>n(t)||(e?e(t):!1)}async function q(r,e){let n=[];async function t(i){let s=await z.readdir(i,{withFileTypes:!0});for(let a of s){if(a.name==="node_modules"||a.name==="dist"||a.name===".git")continue;let u=y.join(i,a.name);if(a.isDirectory()){let g=k(y.relative(r,u));if(e.isIgnored(g)||e.isIgnored(g+"/**"))continue;await t(u);continue}if(a.isFile()){let g=y.extname(a.name).toLowerCase();if(!G.has(g))continue;let w=k(y.relative(r,u));if(e.isIgnored(w))continue;n.push(u)}}}return await t(r),n}async function S(r,e){let n=y.isAbsolute(e)?e:y.join(r,e),t=y.extname(n).toLowerCase();if(!G.has(t))throw new Error(`Unsupported file extension: ${t}`);if(!(await z.stat(n)).isFile())throw new Error(`Not a file: ${n}`);return n}var se=process.cwd();async function ae(){let{cmd:r,fileArg:e,cliType:n,format:t,help:i,version:s,summary:a,printConfig:u,explain:g,invalid:w}=W(process.argv);if(w)return v();if(i)return v();if(s){let p=await H.readFile(new URL("../package.json",import.meta.url),"utf8"),P=JSON.parse(p);console.log(P.version);return}if(!r)return v();if(n&&n!=="fsd"){console.error(`Unknown type: ${n}`),process.exitCode=1;return}let C=n==="fsd"?"fsd":void 0;if(t&&t!=="text"&&t!=="json"&&t!=="sarif"){console.error(`Unknown format: ${t}`),process.exitCode=1;return}let c=se,o=E.join(c,"patternier.config.mjs"),T=!1;try{await H.stat(o),T=!0}catch{}let x=await D(c),I=T?x.type:C??x.type,j=E.join(c,x.rootDir??".");if(u){process.stdout.write(JSON.stringify({config:x,analysisRoot:j,type:I},null,2)+`
`);return}let K=x.ignores??[],Q=await J(E.join(c,".patternierignore")),V=[...B,...K],$=X(V,Q),O={repoRoot:c,analysisRoot:j,config:x};if(r==="inspect"){if(!e)return v();try{let p=await S(c,e),P=await A(I,p,O);process.stdout.write(JSON.stringify(P,null,2)+`
`)}catch(p){console.error(p?.message||p),process.exitCode=1}return}if(r==="check"){let p=[],P=[],N=[],b=new Map,L=g?await le(I):null;if(e){let d;try{d=await S(c,e)}catch(m){console.error(m?.message||m),process.exitCode=1;return}let f=k(E.relative(j,d));if(f.startsWith(".."))p=[d];else if(!$(f))p=[d];else{process.exitCode=0;return}}else p=await q(j,{isIgnored:$});let F=!1;for(let d of p){let f;try{f=await A(I,d,O)}catch(l){F=!0,console.error(l?.message||l);continue}let m=f?.diagnostics??[];if(m.length>0){F=!0;for(let l of m){let M=l.ruleId??"unknown";b.set(M,(b.get(M)??0)+1),t==="json"?P.push({file:f.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error",explain:L?L[l.ruleId]??null:void 0}):t==="sarif"?N.push({file:f.file.relPath,ruleId:l.ruleId,message:l.message,loc:l.loc??null,level:l.level??"error"}):process.stdout.write(_(f.file.relPath,l)+`
`)}}}if(t==="json"?process.stdout.write(JSON.stringify(P,null,2)+`
`):t==="sarif"&&process.stdout.write(JSON.stringify(ce(N),null,2)+`
`),a){let d=Array.from(b.values()).reduce((f,m)=>f+m,0);process.stdout.write(`
Summary: ${d} issues
`);for(let[f,m]of b.entries())process.stdout.write(`- ${f}: ${m}
`)}process.exitCode=F?1:0;return}v()}ae().catch(r=>{console.error(r?.stack||r),process.exitCode=1});function ce(r){let e=new Map,n=r.map(t=>{e.has(t.ruleId)||e.set(t.ruleId,{id:t.ruleId});let i={physicalLocation:{artifactLocation:{uri:t.file}}};return t.loc&&typeof t.loc.line=="number"&&typeof t.loc.col=="number"&&(i.physicalLocation.region={startLine:t.loc.line,startColumn:t.loc.col}),{ruleId:t.ruleId,level:t.level==="warn"?"warning":"error",message:{text:t.message},locations:[i]}});return{version:"2.1.0",$schema:"https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0.json",runs:[{tool:{driver:{name:"patternier",rules:Array.from(e.values())}},results:n}]}}async function le(r){return r==="fsd"?(await import("./explain-NQS3P6YS.js")).fsdRuleExplain:{}}
